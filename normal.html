<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Stacking Rectangles with Sound & Recording</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
        }
        #uploadButton {
            top: 70px;
        }
    </style>
</head>
<body>

<button id="recordButton">Start Recording</button>
<button id="uploadButton">Upload Image</button>
<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const recordButton = document.getElementById("recordButton");
    const uploadButton = document.getElementById("uploadButton");
    
    let recorder;
    let chunks = [];
    let videoStream;
    let audioContext;
    let audioStream;

    let randomPattern = true;
    let uploadedImageData = null;

    // Scale the canvas to the full window size
    function resizeCanvas() {
        const aspectRatio = 16 / 9; // Standard video ratio (adjustable if you want a different ratio)
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        if (windowWidth / windowHeight > aspectRatio) {
            canvas.width = windowHeight * aspectRatio;
            canvas.height = windowHeight;
        } else {
            canvas.width = windowWidth;
            canvas.height = windowWidth / aspectRatio;
        }
    }

    function getRandomColor() {
        if (uploadedImageData) {
            const randomIndex = Math.floor(Math.random() * uploadedImageData.data.length / 4) * 4;
            const r = uploadedImageData.data[randomIndex];
            const g = uploadedImageData.data[randomIndex + 1];
            const b = uploadedImageData.data[randomIndex + 2];
            return `rgb(${r}, ${g}, ${b})`;
        }
        return `hsl(${Math.random() * 360}, 80%, 60%)`;
    }

    function getRandomPitch() {
        return Math.pow(Math.random(), 2) * 1000 + 200;
    }

    function playSound() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        
        osc.type = ["sine", "square", "triangle", "sawtooth"][Math.floor(Math.random() * 4)];
        osc.frequency.value = getRandomPitch();
        gain.gain.value = Math.random() * 0.5;

        osc.connect(gain);
        gain.connect(audioContext.destination);

        osc.start();
        setTimeout(() => {
            osc.stop();
        }, 150);

        // Capture audio for the recording
        const source = audioContext.createMediaStreamSource(audioContext.destination);
        audioStream = new MediaStream();
        audioStream.addTrack(source.context.createGain().gain);
    }

    function drawRectangle() {
        const width = Math.random() * 150 + 20;
        const height = Math.random() * 150 + 20;
        const angle = Math.random() * 360;

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const spread = Math.random() < 0.7 ? 200 : canvas.width; 

        const x = centerX + (Math.random() - 0.5) * spread;
        const y = centerY + (Math.random() - 0.5) * spread;

        ctx.fillStyle = getRandomColor();
        ctx.save();
        ctx.translate(x + width / 2, y + height / 2);
        ctx.rotate(angle * Math.PI / 180);
        ctx.fillRect(-width / 2, -height / 2, width, height);
        ctx.restore();

        if (Math.random() < 0.5) {
            playSound();
        }

        if (Math.random() < 0.1) {
            playSound();
        }
    }

    function drawCircle() {
        const radius = Math.random() * 100 + 50;

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const spread = Math.random() < 0.7 ? 200 : canvas.width;

        const x = centerX + (Math.random() - 0.5) * spread;
        const y = centerY + (Math.random() - 0.5) * spread;

        ctx.fillStyle = getRandomColor();
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();

        playSound();
    }

    function drawPolygon() {
        const sides = Math.floor(Math.random() * 5) + 3; // between 3 and 7 sides
        const radius = Math.random() * 100 + 50;

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const spread = Math.random() < 0.7 ? 200 : canvas.width;

        const x = centerX + (Math.random() - 0.5) * spread;
        const y = centerY + (Math.random() - 0.5) * spread;

        ctx.fillStyle = getRandomColor();
        ctx.beginPath();
        for (let i = 0; i < sides; i++) {
            const angle = (i * 2 * Math.PI) / sides;
            const px = x + radius * Math.cos(angle);
            const py = y + radius * Math.sin(angle);
            ctx.lineTo(px, py);
        }
        ctx.closePath();
        ctx.fill();

        playSound();
    }

    function startDrawing() {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        setInterval(() => {
            if (randomPattern) {
                [drawRectangle, drawCircle, drawPolygon][Math.floor(Math.random() * 3)]();
            } else {
                drawRectangle();
            }
        }, 100);

        setInterval(() => {
            document.body.style.backgroundColor = getRandomColor();
        }, 1000);
    }

    function startRecording() {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height); 

        if (recorder) {
            recorder.stop();
        }

        videoStream = canvas.captureStream(30);

        // Combine the audio and video streams
        const combinedStream = new MediaStream();
        videoStream.getTracks().forEach(track => combinedStream.addTrack(track));
        audioStream.getTracks().forEach(track => combinedStream.addTrack(track));

        recorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm' });

        chunks = [];
        recorder.ondataavailable = (e) => chunks.push(e.data);
        recorder.onstop = saveRecording;

        recorder.start();
        recordButton.textContent = "Recording...";
        recordButton.disabled = true;
        recordButton.style.display = "none";  // Hide the start recording button

        uploadButton.style.display = "none";  // Hide the upload button

        setTimeout(() => {
            recorder.stop();
            recordButton.textContent = "Start Recording";
            recordButton.disabled = false;
            recordButton.style.display = "block"; // Make it reappear after recording is finished
        }, 5000);
    }

    function saveRecording() {
        const blob = new Blob(chunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "recording.mp4";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Create a canvas to extract colors
                    const imgCanvas = document.createElement("canvas");
                    const imgCtx = imgCanvas.getContext("2d");
                    imgCanvas.width = img.width;
                    imgCanvas.height = img.height;
                    imgCtx.drawImage(img, 0, 0);
                    uploadedImageData = imgCtx.getImageData(0, 0, img.width, img.height);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    startDrawing();
    recordButton.addEventListener("click", startRecording);

    uploadButton.addEventListener("click", function() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = handleImageUpload;
        input.click();
    });

    document.addEventListener("click", () => {
        randomPattern = !randomPattern;  // Toggle between random patterns and fixed rectangles
    });
</script>

</body>
</html>
